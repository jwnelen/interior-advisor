# Better Auth Setup & Migration Guide

Better Auth with Convex integration has been successfully installed! This guide will help you complete the setup and migrate your existing code.

## âœ… What's Been Done

1. **Packages installed:**
   - `better-auth@1.4.9`
   - `@convex-dev/better-auth`

2. **Configuration files created:**
   - `convex/auth.config.ts` - Auth configuration
   - `convex/convex.config.ts` - Component registration
   - `convex/http.ts` - HTTP route handlers
   - `convex/betterAuth/` - Better Auth component files
   - `lib/auth-client.ts` - Client-side auth instance
   - `lib/auth-server.ts` - Server-side auth helpers
   - `app/api/auth/[...all]/route.ts` - Next.js API route handlers

3. **UI components created:**
   - `app/sign-in/page.tsx` - Magic link sign-in page

4. **Providers updated:**
   - `components/providers/convex-provider.tsx` - Now uses `ConvexBetterAuthProvider`
   - `app/layout.tsx` - Now fetches and passes auth token

5. **Schema updated:**
   - `sessionId` â†’ `userId` in projects, styleQuizResponses, and rateLimits tables
   - Indexes updated accordingly

6. **Helper utilities created:**
   - `convex/auth.ts` - Helper functions for getting authenticated user

## ðŸ”§ Required Setup Steps

### 1. Set Environment Variables

First, ensure your Convex deployment is running:

```bash
pnpm exec convex dev
```

Then, in a separate terminal, set the required environment variables:

```bash
# Generate and set Better Auth secret
pnpm exec convex env set BETTER_AUTH_SECRET $(openssl rand -base64 32)

# Set your site URL (for development)
pnpm exec convex env set SITE_URL http://localhost:3000
```

### 2. Create .env.local

Copy the example file and fill in your Convex URLs (generated by `pnpm exec convex dev`):

```bash
cp .env.local.example .env.local
```

Edit `.env.local` and update with your actual Convex deployment URL:

```env
# From `pnpm exec convex dev` output
CONVEX_DEPLOYMENT=dev:your-deployment-name
NEXT_PUBLIC_CONVEX_URL=https://your-deployment.convex.cloud
NEXT_PUBLIC_CONVEX_SITE_URL=https://your-deployment.convex.site

# Your local site URL
NEXT_PUBLIC_SITE_URL=http://localhost:3000
```

### 3. Configure Email Sending for Magic Links

Edit `convex/betterAuth/auth.ts` and implement the `sendMagicLink` function. Currently, it logs to console (development only).

**Recommended email services:**
- [Resend](https://resend.com) (Simple, modern API)
- [SendGrid](https://sendgrid.com)
- [AWS SES](https://aws.amazon.com/ses/)
- [Postmark](https://postmarkapp.com)

Example with Resend:

```typescript
// convex/betterAuth/auth.ts
import { Resend } from 'resend';

const resend = new Resend(process.env.RESEND_API_KEY);

magicLink({
  sendMagicLink: async ({ email, url }) => {
    await resend.emails.send({
      from: 'Your App <noreply@yourdomain.com>',
      to: email,
      subject: 'Sign in to Interior Advisor',
      html: `
        <h2>Sign in to Interior Advisor</h2>
        <p>Click the link below to sign in:</p>
        <a href="${url}">${url}</a>
        <p>This link will expire in 15 minutes.</p>
      `,
    });
  },
}),
```

Don't forget to set the API key in Convex:

```bash
pnpm exec convex env set RESEND_API_KEY your_api_key_here
```

## ðŸ”„ Migrating Existing Code

Your codebase currently uses `sessionId` for anonymous sessions. Here's how to migrate:

### 1. Update Convex Queries & Mutations

Replace all uses of `sessionId` with `userId` obtained from auth context.

**Before:**
```typescript
export const getProjects = query({
  args: { sessionId: v.string() },
  handler: async (ctx, { sessionId }) => {
    return await ctx.db
      .query("projects")
      .withIndex("by_session", (q) => q.eq("sessionId", sessionId))
      .collect();
  },
});
```

**After:**
```typescript
import { requireUserId } from "./auth";

export const getProjects = query({
  args: {},
  handler: async (ctx) => {
    const userId = await requireUserId(ctx);
    return await ctx.db
      .query("projects")
      .withIndex("by_user", (q) => q.eq("userId", userId))
      .collect();
  },
});
```

### 2. Update Client-Side Queries

Remove `sessionId` from query/mutation calls.

**Before:**
```typescript
const sessionId = useLocalSession();
const projects = useQuery(api.projects.getProjects,
  sessionId ? { sessionId } : "skip"
);
```

**After:**
```typescript
const projects = useQuery(api.projects.getProjects);
```

### 3. Remove useLocalSession Hook

Delete or deprecate `lib/hooks/use-local-session.ts` - it's no longer needed!

### 4. Add Authentication Guards

For protected pages, check authentication status:

```typescript
// app/dashboard/page.tsx
import { isAuthenticated } from "@/lib/auth-server";
import { redirect } from "next/navigation";

export default async function DashboardPage() {
  const hasAuth = await isAuthenticated();

  if (!hasAuth) {
    redirect("/sign-in");
  }

  // ... rest of your page
}
```

Or use the client-side approach:

```typescript
"use client";

import { useQuery } from "convex/react";
import { api } from "@/convex/_generated/api";
import { useRouter } from "next/navigation";
import { useEffect } from "react";

export default function DashboardPage() {
  const router = useRouter();
  const user = useQuery(api.auth.getCurrentUser);

  useEffect(() => {
    if (user === null) {
      router.push("/sign-in");
    }
  }, [user, router]);

  if (user === undefined) return <div>Loading...</div>;
  if (user === null) return null; // Redirecting...

  return <div>Welcome {user.name}!</div>;
}
```

### 5. Update Landing Page

Add a sign-in button/link to your landing page:

```typescript
import Link from "next/link";
import { Button } from "@/components/ui/button";

<Button asChild>
  <Link href="/sign-in">Get Started</Link>
</Button>
```

## ðŸ§ª Testing the Setup

1. Start your development servers:
   ```bash
   # Terminal 1
   pnpm exec convex dev

   # Terminal 2
   pnpm dev
   ```

2. Navigate to `http://localhost:3000/sign-in`

3. Enter your email address

4. Check the console logs for the magic link URL (since email isn't configured yet)

5. Copy the magic link URL and paste it into your browser

6. You should be redirected to `/dashboard` and authenticated!

## ðŸ“š Key Files to Update

Here are the main files you'll need to update:

- [ ] `convex/projects.ts` - Update all queries/mutations
- [ ] `convex/rooms.ts` - Update all queries/mutations
- [ ] `convex/analyses.ts` - Update internal actions if they use sessionId
- [ ] `convex/recommendations.ts` - Update internal actions if they use sessionId
- [ ] `convex/visualizations.ts` - Update internal actions if they use sessionId
- [ ] `app/dashboard/page.tsx` - Add auth guard
- [ ] `app/project/[id]/page.tsx` - Add auth guard
- [ ] `app/` - Landing page - Add sign-in button
- [ ] Remove `lib/hooks/use-local-session.ts`

## ðŸ†˜ Troubleshooting

### "No CONVEX_DEPLOYMENT set" error
Run `pnpm exec convex dev` first to initialize your deployment.

### Magic link not working
1. Check console logs for the URL
2. Ensure `SITE_URL` is set correctly in Convex env
3. Verify `.env.local` has correct URLs

### "Unauthenticated" errors
1. Make sure you're signed in
2. Check that `getToken()` is being called in layout.tsx
3. Verify ConvexBetterAuthProvider is wrapping your app

### TypeScript errors after updates
Run `pnpm exec convex dev` to regenerate types, then restart your Next.js dev server.

## ðŸ“– Additional Resources

- [Better Auth Documentation](https://www.better-auth.com)
- [Convex Better Auth Integration](https://labs.convex.dev/better-auth)
- [Convex Documentation](https://docs.convex.dev)

## ðŸŽ‰ Next Steps

1. Complete the required setup steps above
2. Configure email sending for production use
3. Update your Convex functions to use `userId` instead of `sessionId`
4. Add authentication guards to protected pages
5. Test the complete authentication flow
6. Deploy to production!

---

If you encounter any issues, check the Better Auth + Convex documentation or ask for help!
